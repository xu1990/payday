# 技术方案 - 按模块细化

从 [技术方案_v1.0.md](技术方案_v1.0.md) 抽取各模块的接口约定、表结构要点、缓存/队列使用，并与 [迭代规划_Sprint与任务.md](迭代规划_Sprint与任务.md) 的 Sprint 对应。

---

## 1. 发薪日模块

**对应 Sprint**：1.1

| 类别 | 要点 |
|------|------|
| **API** | 发薪日配置 CRUD；公历/农历、多工作；与 技术方案 2.1.1 payday 路由一致 |
| **表** | PaydayConfig：user_id、payday_type、day、lunar_*、work_name 等 |
| **缓存** | payday:status:{user_id}:{date}，TTL 1 天；更新/删除配置时删缓存 |
| **队列** | 无 |

---

## 2. 工资记录模块

**对应 Sprint**：1.2、1.3；Phase 3 增强在 3.3

| 类别 | 要点 |
|------|------|
| **API** | 记录 CRUD；列表按 user_id + payday_date/created_at；金额加密传输与存储 |
| **表** | SalaryRecord；amount 存 amount_encrypted；Phase 3 增加税前、扣税、来源、延迟等字段；索引 idx_salary_user_date、idx_salary_stats（技术方案 2.2.2） |
| **缓存** | 列表可短 TTL 或 Cache-Aside；统计结果可缓存（技术方案 2.3） |
| **队列** | 无（风控在帖子侧） |

---

## 3. 统计模块

**对应 Sprint**：1.3（本月/年度）、3.2（数据洞察）

| 类别 | 要点 |
|------|------|
| **API** | 本月/年度汇总、趋势；Phase 3 行业/城市/区间/发薪日分布（数据洞察） |
| **表** | 主要查 salary_records；聚合；可选统计库/ES（技术方案 2.2.1） |
| **缓存** | 汇总结果可缓存，短 TTL；与 2.3.2 一致 |
| **队列** | 可选：calculate_user_stats_task、calculate_daily_stats（Celery） |

---

## 4. 帖子模块

**对应 Sprint**：2.1、2.2

| 类别 | 要点 |
|------|------|
| **API** | 发帖 POST；列表（热门/最新）GET；详情；与 2.1.1 post 路由一致；发布后写 risk_status=pending，异步审核后更新 |
| **表** | Post；分表按 created_at 按月（技术方案 2.2.1）；索引 idx_posts_hot、idx_posts_user、idx_posts_tag |
| **缓存** | post:hot:{date} ZSet；post:view:{post_id} INCR；like 状态 like:status:{user}:post:{id} |
| **队列** | risk_check_task、content_moderation_task；审核完成后更新 risk_status、拒则下架+通知 |

---

## 5. 评论与点赞模块

**对应 Sprint**：2.2

| 类别 | 要点 |
|------|------|
| **API** | 评论 CRUD、二级回复；点赞/取消；与 2.1.1 comment/like 一致 |
| **表** | Comment（post_id、parent_id、reply_to）；Like（target_type、target_id、user_id）；索引 2.2.2 |
| **缓存** | 点赞状态；评论数/点赞数可缓存或异步更新 |
| **队列** | 评论/点赞后通知任务；内容审核若评论也需走风控队列 |

---

## 6. 风控模块

**对应 Sprint**：2.3；后台 2.4

| 类别 | 要点 |
|------|------|
| **API** | 风控服务接口（内部调用）；管理后台待审列表、通过/拒绝（技术方案 2.1.2、3.2） |
| **表** | 风控结果可落库（risk 库）；与 2.2.1 分库一致 |
| **缓存** | risk:check:{target_type}:{target_id}，TTL 30 天 |
| **队列** | risk_check_task、content_moderation_task；文本+图片+OCR，评分、拒绝下架+通知 |

---

## 7. 通知模块

**对应 Sprint**：2.2

| 类别 | 要点 |
|------|------|
| **API** | 通知列表、未读数、已读；与 2.1.1 notification 一致 |
| **表** | Notification；可按 user_id 分表（2.2.1） |
| **缓存** | 未读数可缓存；列表 Cache-Aside |
| **队列** | 评论/回复/点赞后发通知任务；可选订阅消息（发薪提醒等） |

---

## 8. 管理后台

**对应 Sprint**：1.4（用户/记录/统计）、2.4（内容/风控）、3.5（运营/商业）

| 类别 | 要点 |
|------|------|
| **API** | admin 下 user、content、risk、system；与 2.1.1 admin API 一致；鉴权 admin 角色 |
| **表** | 与业务表共用；无独立表 |
| **缓存** | 列表可短缓存；风控待审实时查库 |
| **队列** | 无（后台操作同步） |

---

## 9. 关注模块（Phase 3）

**对应 Sprint**：3.1

| 类别 | 要点 |
|------|------|
| **API** | 关注/取关；粉丝列表、关注列表；关注流（动态） |
| **表** | Follow（follower_id、following_id）；技术方案 迭代 3.2 数据模型 |
| **缓存** | follow:list:{user_id}:following Set；关注流可 ZSet 或读库 |
| **队列** | 可选异步写关注流 |

---

## 10. 数据洞察（Phase 3）

**对应 Sprint**：3.2

| 类别 | 要点 |
|------|------|
| **API** | 行业/城市/区间/发薪日分布；个人报告 |
| **表** | 查 salary_records + 用户维度；可选统计库/ES |
| **缓存** | 分布结果可缓存 |
| **队列** | 可选定时计算统计 |

---

## 11. 会员与主题（Phase 3）

**对应 Sprint**：3.5

| 类别 | 要点 |
|------|------|
| **API** | 会员权益、主题列表、订单（MembershipOrder、Theme）；支付预留 |
| **表** | 技术方案 迭代 3.2 MembershipOrder、Theme |
| **缓存** | 会员状态、主题列表可缓存 |
| **队列** | 支付回调可异步 |

---

## 与 Sprint 的对应关系汇总

| 模块 | 主要 Sprint |
|------|-------------|
| 发薪日 | 1.1 |
| 工资记录 | 1.2、1.3；3.3 增强 |
| 统计 | 1.3、3.2 |
| 帖子 | 2.1、2.2 |
| 评论/点赞 | 2.2 |
| 风控 | 2.3、2.4 |
| 通知 | 2.2 |
| 管理后台 | 1.4、2.4、3.5 |
| 关注 | 3.1 |
| 数据洞察 | 3.2 |
| 会员/主题 | 3.5 |

接口路径、请求方法以 技术方案_v1.0 中 api/ 与路由为准；表结构以 2.2 与迭代规划数据模型为准。
